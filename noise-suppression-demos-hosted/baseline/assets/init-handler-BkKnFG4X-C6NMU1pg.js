import{m as S,d as x,i as H,t as B,e as z,j as G,Z as h,n as p,G as M,S as g,Q as l,D as q,k as X,A as V,l as A,s as P,p as W,q as T,O as $,M as j}from"./index-d9wy7qxQ.js";import"vite-plugin-node-polyfills/shims/process";import"vite-plugin-node-polyfills/shims/buffer";function _(u){return S(function(){return u})}function Q(u,e){return x(function(t,s){return H(u(t,s)).pipe(B(1),_(t))})}function O(u,e){e===void 0&&(e=G);var t=z(u,e);return Q(function(){return t})}class b{static rawUsageFrom(e,t){return(e<<16|t)>>>0}static usagePageFromRaw(e){return e>>>16}static usageFromRaw(e){return e<<16>>>16}}class Z{constructor(e){this.devices=new Map,this.deviceInputSubscriptions=new Map,this.onHidInput=new g,this.onGetFeatureReportResponse=new g;const t=new g;this.deviceAdded=t;const s=new g;this.deviceRemoved=s,e.deviceAdded.subscribe((r=>{if(!this.devices.has(r.id)){this.devices.set(r.id,r);const o=r.inputHandler.inputReports.pipe(S((i=>new X(r.id,b.usagePageFromRaw(i.usage),b.usageFromRaw(i.usage),i.value)))).subscribe((i=>this.onHidInput.next(i)));this.deviceInputSubscriptions.set(r.id,o),t.next(r)}})),e.deviceRemoved.subscribe((r=>{var o;const i=this.devices.get(r);i&&(this.devices.delete(r),(o=this.deviceInputSubscriptions.get(r))===null||o===void 0||o.unsubscribe(),this.deviceInputSubscriptions.delete(r),s.next(i))}))}sendOutputUsage(e,t,s,r){var o,i;const n=b.rawUsageFrom(t,s);return(i=(o=this.devices.get(e))===null||o===void 0?void 0:o.outputHandler.sendOutputUsage(n,r))!==null&&i!==void 0?i:Promise.resolve()}setFeatureUsage(e,t,s,r){var o;const i=b.rawUsageFrom(t,s);(o=this.devices.get(e))===null||o===void 0||o.featureHandler.setFeatureUsage(i,r)}getFeatureUsage(e,t,s,r){return l(this,void 0,void 0,(function*(){var o;const i=b.rawUsageFrom(s,r),n=yield(o=this.devices.get(e))===null||o===void 0?void 0:o.featureHandler.getFeatureUsage(i);n!==void 0&&this.onGetFeatureReportResponse.next(new V(t,n))}))}}class D{constructor(e){this.data=new Uint8Array(e)}get buffer(){return new DataView(this.data.buffer)}getBits(e,t){if(t>8*this.data.length-e)throw new Error("Not enough bits to read from the buffer");let s=e,r=0;for(let o=0;o<t;){const i=t-o,n=7&s,d=this.data[s>>3],a=Math.min(i,8-n);r|=(d>>n&~(255<<a))<<o,s+=a,o+=a}return r>>>0}setBits(e,t,s){if(s>8*this.data.length-e)throw new Error("Not enough bits to read from the buffer");let r=e,o=t;for(let i=0;i<s;){const n=s-i,d=7&r,a=r>>3,f=Math.min(n,8-d),c=~(255<<f),v=o&c;o>>=f;const R=~(c<<d);this.data[a]=this.data[a]&R|v<<d,r+=f,i+=f}}}const J=9;class U{constructor(e,t){this.device=e,this.inputReportDescriptors=t;const s=new Map;this.inputReportDescriptors.forEach((o=>{o.usages.forEach(((i,n)=>{s.set(n,[0])}))}));const r=new g;this.inputReports=r,this.device.oninputreport=o=>{if(o.currentTarget!==this.device)return;const i=this.inputReportDescriptors.get(o.reportId);if(!i)return;const n=new D(o.data.buffer);let d=Array.from(i.usages.entries(),(a=>U.makeWebHidInputReport(n,a)));o.reportId!==J&&(d=d.filter((a=>U.compareReportToCachedValue(a,s))),d.forEach((a=>{s.set(a.usage,a.value)}))),d.forEach((a=>{r.next(a)}))}}static makeWebHidInputReport(e,[t,s]){let r=s.offset,o=s.size*s.count,i=[];for(;o>0;)i.push(e.getBits(r,Math.min(o,8))),r+=8,o-=8;return i=s.onInput(i),new j.UsageReport(t,i)}static compareReportToCachedValue(e,t){const s=t.get(e.usage);return!s||s.length!==e.value.length?!0:s.some(((r,o)=>e.value[o]!==r))}}class N{constructor(e){this.report=e}reportSizeInBits(){return this.report.fullReportSize}reportSizeInBytes(){return Math.ceil(this.reportSizeInBits()/8)}createBitViewIfNeeded(){if(!this.bitView){const e=this.reportSizeInBytes(),t=new ArrayBuffer(e);this.bitView=new D(t)}return this.bitView}getUsageInformationOrThrow(e){if(!this.report.usages.has(e))throw new h(`Unable to write usage (0x${e.toString(16).padStart(8,"0")}). It is not known by the device.`,p.UNEXPECTED_ERROR);return this.report.usages.get(e)}writeUsage(e,t){const s=this.getUsageInformationOrThrow(e);let r=this.createBitViewIfNeeded();if(!s.absolute){const n=(function(d){const a=new ArrayBuffer(d.byteLength);return new Uint8Array(a).set(new Uint8Array(d.buffer)),a})(r.buffer);r=new D(n)}let o=s.offset,i=s.size*s.count;return t.forEach((n=>{r.setBits(o,n,i),o+=8,i-=8})),new Uint8Array(r.buffer.buffer)}}class K{constructor(e,t,s){this.device=e,this.outputReports=t,this.outputUsages=s,this.outputCacheByReportId=new Map}getReportIdForUsage(e){if(!this.outputUsages.has(e))throw new h(`Unknown usagePage: 0x${e.toString(16).padStart(8,"0")}.`,p.UNEXPECTED_ERROR);return this.outputUsages.get(e)}getReportLayoutForReportId(e){if(!this.outputReports.has(e))throw new h(`Unknown reportId: ${e}.`,p.UNEXPECTED_ERROR);return this.outputReports.get(e)}getUsageInReportForUsage(e){const t=this.getReportIdForUsage(e),s=this.getReportLayoutForReportId(t);if(!s.usages.has(e))throw new h(`Unknown rawUsage inside ReportLayout: ${e}.`,p.UNEXPECTED_ERROR);return s.usages.get(e)}getOrCreateCacheForReportId(e){if(!this.outputCacheByReportId.has(e)){const t=this.getReportLayoutForReportId(e),s=new N(t);this.outputCacheByReportId.set(e,s)}return this.outputCacheByReportId.get(e)}sendOutputUsage(e,t){return l(this,void 0,void 0,(function*(){const s=this.getReportIdForUsage(e),r=this.getOrCreateCacheForReportId(s),o=this.getUsageInReportForUsage(e).onOutput(t),i=r.writeUsage(e,o);try{yield this.device.sendReport(s,i)}catch(n){throw n.name==="NotAllowedError"?new h("The request could not be sent to the device. The device may have been disconnected.",p.DEVICE_ERROR):n}}))}}class Y{constructor(e=new Map,t=0){this.usages=e,this.fullReportSize=t}}class ee{constructor(e,t,s,r){this.offset=e,this.size=t,this.count=s,this.absolute=r}onInput(e){return e}onOutput(e){return e}}class k{constructor(e,t,s,r,o){this.offset=e,this.size=t,this.count=s,this.absolute=r,this.rangeIndex=o}onInput(e){if(e.length>1)throw new h(`Usages of type ${k.name} should not hold more than 1 byte of information.`,p.UNEXPECTED_ERROR);return e[0]===this.rangeIndex?[1]:[0]}onOutput(e){if(e.length>1)throw new h(`Usages of type ${k.name} should not hold more than 1 byte of information.`,p.UNEXPECTED_ERROR);return e[0]>0?[this.rangeIndex]:e}}class I{constructor(e){const t=new Map;this.buildReportLayouts(e.collections,"input",t),this.inputReports=t,this.inputUsages=I.buildUsageMap(t);const s=new Map;this.buildReportLayouts(e.collections,"output",s),this.outputReports=s,this.outputUsages=I.buildUsageMap(s);const r=new Map;this.buildReportLayouts(e.collections,"feature",r),this.featureReports=r,this.featureUsages=I.buildUsageMap(r)}static buildUsageMap(e){const t=new Map;return e.forEach(((s,r)=>{s.usages.forEach(((o,i)=>{t.set(i,r)}))})),t}buildReportLayouts(e,t,s){e.forEach((r=>{var o;(o=I.reportsOfType(r,t))===null||o===void 0||o.forEach((i=>{var n;const d=i.reportId;s.has(d)||s.set(d,new Y);const a=s.get(d);let f=0;(n=i.items)===null||n===void 0||n.forEach((c=>{let v=c.usages;if(c.isRange){v=[];for(let w=c.usageMinimum;w<=c.usageMaximum;w+=1)v.push(w)}let R,y=f;if(c.isRange&&c.isArray&&(R=1),v.length>0&&v.filter((w=>a.usages.has(w))).length===v.length)return;v.forEach((w=>{let F;const C=v.length>1?c.reportCount/v.length:c.reportCount;F=R?new k(y,c.reportSize,C,c.isAbsolute,R):new ee(y,c.reportSize,C,c.isAbsolute),a.usages.set(w,F),R?R+=1:y+=c.reportSize}));const L=c.reportCount*c.reportSize;a.fullReportSize+=L,f+=L}))})),r.children&&this.buildReportLayouts(r.children,t,s)}))}static reportsOfType(e,t){if(t==="input")return e.inputReports;if(t==="output")return e.outputReports;if(t==="feature")return e.featureReports;throw new h(`Unexpected report type: ${t}!`,p.UNEXPECTED_ERROR)}}class te{constructor(e,t,s){this.device=e,this.featureReports=t,this.featureUsages=s,this.outputCacheByReportId=new Map}getReportIdForUsage(e){if(!this.featureUsages.has(e))throw new h(`Unknown usagePage: 0x${e.toString(16).padStart(8,"0")}.`,p.UNEXPECTED_ERROR);return this.featureUsages.get(e)}getReportLayoutForReportId(e){if(!this.featureReports.has(e))throw new h(`Unknown reportId: ${e}.`,p.UNEXPECTED_ERROR);return this.featureReports.get(e)}getUsageInReportForUsage(e){const t=this.getReportIdForUsage(e),s=this.getReportLayoutForReportId(t);if(!s.usages.has(e))throw new h(`Unknown rawUsage inside ReportLayout: ${e}.`,p.UNEXPECTED_ERROR);return s.usages.get(e)}getOrCreateCacheForReportId(e){if(!this.outputCacheByReportId.has(e)){const t=this.getReportLayoutForReportId(e),s=new N(t);this.outputCacheByReportId.set(e,s)}return this.outputCacheByReportId.get(e)}getFeatureUsage(e){return l(this,void 0,void 0,(function*(){const t=this.getReportIdForUsage(e),s=yield this.device.receiveFeatureReport(t),r=this.getUsageInReportForUsage(e),o=[];for(let i=1;i<=Math.ceil(r.size/8);i+=1)o.push(s.getUint8(i));return o}))}setFeatureUsage(e,t){return l(this,void 0,void 0,(function*(){const s=this.getReportIdForUsage(e),r=this.getOrCreateCacheForReportId(s),o=this.getUsageInReportForUsage(e).onOutput(t),i=r.writeUsage(e,o);yield this.device.sendFeatureReport(s,i)}))}}class se{constructor(e,t,s,r){this.name=e,this.vid=t,this.pid=s,this.id=r.sessionId;const o=new I(r);this.inputReports=o.inputReports,this.outputReports=o.outputReports,this.featureReports=o.featureReports,this.inputHandler=new U(r,o.inputReports),this.outputHandler=new K(r,o.outputReports,o.outputUsages),this.featureHandler=new te(r,o.featureReports,o.featureUsages)}}class E{constructor(e,t){this.hid=e,this.broadcastChannel=t,this.deviceAddedSubject=new g,this.deviceAdded=this.deviceAddedSubject,this.deviceRemovedSubject=new g,this.deviceRemoved=this.deviceRemovedSubject}setupListeners(){this.hid.onconnect=e=>this.onConnect(e),this.hid.ondisconnect=e=>this.onDisconnect(e),this.broadcastChannel.onmessage=()=>this.getPairedDevices()}addNewDevice(e){return l(this,void 0,void 0,(function*(){if(E.hasGeneratedDeviceId(e))return;E.getOrGenerateDeviceId(e);const t=new se(e.productName,e.vendorId,e.productId,e);e.opened||(yield e.open()),this.deviceAddedSubject.next(t)}))}onConnect(e){return l(this,void 0,void 0,(function*(){setTimeout((()=>l(this,void 0,void 0,(function*(){yield this.addNewDevice(e.device)}))),1e3)}))}onDisconnect(e){const t=E.getOrGenerateDeviceId(e.device);this.deviceRemovedSubject.next(t)}getPairedDevices(){return l(this,void 0,void 0,(function*(){(yield this.hid.getDevices()).filter((e=>e.vendorId===M.VENDOR_ID)).forEach((e=>l(this,void 0,void 0,(function*(){yield this.addNewDevice(e)}))))}))}static hasGeneratedDeviceId(e){return e.sessionId!==void 0}static getOrGenerateDeviceId(e){if(!E.hasGeneratedDeviceId(e)){const t=new q(4).toString();return e.sessionId=t,t}return e.sessionId}}class re{constructor(e,t,s,r,o){this.usagePage=e,this.usage=t,this.valueType=s,this.reportType=r,this.reportSize=o}}class m{constructor(e){this.deviceManagement=e,this.events=new g,this.setupDeviceHandler()}setupDeviceHandler(){this.deviceManagement.deviceAdded.subscribe((e=>{this.events.next({event:"attach",id:e.id,vid:e.vid,pid:e.pid,name:e.name,serialNumber:e.id,descriptor:m.generateDescriptors(e)})})),this.deviceManagement.deviceRemoved.subscribe((e=>{this.events.next({event:"detach",id:e.id})})),this.deviceManagement.onHidInput.subscribe((e=>{const t=e.value.length===1?e.value[0]:e.value;this.events.next({event:"hid-input",id:e.deviceId,usagePage:e.usagePage,usage:e.usage,value:t})})),this.deviceManagement.onGetFeatureReportResponse.subscribe((e=>{const t=e.value.length===1?e.value[0]:e.value;this.events.next({event:"response-hid-feature",token:e.token,value:t})}))}static generateDescriptors(e){let t=m.convertReportLayoutsToDescriptors(e.inputReports,"input");return t=t.concat(m.convertReportLayoutsToDescriptors(e.outputReports,"output")),t=t.concat(m.convertReportLayoutsToDescriptors(e.featureReports,"feature")),t}static convertReportLayoutsToDescriptors(e,t){const s=[];return e.forEach((r=>{r.usages.forEach(((o,i)=>{const n=b.usagePageFromRaw(i);n===65280&&t==="output"||s.push(new re(n,b.usageFromRaw(i),o.absolute?"absolute":"relative",t,Math.ceil(o.size*o.count/8)))}))})),s}}class oe{constructor(e,t,s){this.deviceManagement=e,this.callLockManagement=t,this.logger=s,this.gnpLockAcquired=new g,this.callLockAcquired=new g,this.softphoneInFocus=new g,this.events=A(this.gnpLockAcquired.pipe(O(0)),this.callLockAcquired.pipe(O(0)),this.softphoneInFocus)}onNewSdkInput(e){return l(this,void 0,void 0,(function*(){if(!e.action)throw new h("Provided input has no action property.",p.UNEXPECTED_ERROR);switch(e.action){case"hid-output":{const t=Array.isArray(e.value)?e.value:[e.value];yield this.deviceManagement.sendOutputUsage(e.id,e.usagePage,e.usage,t);break}case"request-hid-feature":this.deviceManagement.getFeatureUsage(e.id,e.token,e.usagePage,e.usage);break;case"set-hid-feature":{const t=Array.isArray(e.value)?e.value:[e.value];this.deviceManagement.setFeatureUsage(e.id,e.usagePage,e.usage,t);break}case"request-gnp-lock":this.gnpLockAcquired.next({event:"response-gnp-lock",token:e.token}),P("GNP lock requested with WebHID backend. This should not happen!",this.logger,T.ERROR,W.NATIVE_CONSOLE);break;case"release-gnp-lock":break;case"request-call-lock":this.callLockManagement.tryAcquireCallLock(e.id).then((t=>{this.callLockAcquired.next({event:"response-call-lock",id:e.id,acquired:t})}));break;case"release-call-lock":this.callLockManagement.releaseCallLock(e.id);break;case"set-softphone-info":this.softphoneInFocus.next({event:"softphone-in-focus",infocus:!1}),this.softphoneInFocus.complete();break;default:throw new h(`Provided action is not recognized - ${e.action}.`,p.UNEXPECTED_ERROR)}}))}}class ie{constructor(e,t,s){this.navigatorLocks=e,this.logger=s,this.releaseGlobalLock=null,this.localLockedDevices=new Set,t.deviceRemoved.subscribe((r=>{this.localLockedDevices.has(r.id)&&this.releaseCallLock(r.id)}))}tryAcquireCallLock(e){return l(this,void 0,void 0,(function*(){return!(yield this.checkWebLocksSupport())||(this.localLockedDevices.size>0&&!this.localLockedDevices.has(e)?(this.localLockedDevices.add(e),!0):new Promise((t=>{this.navigatorLocks.request("jabra-call-lock",{ifAvailable:!0},(s=>s?(this.localLockedDevices.add(e),t(!0),new Promise((r=>{this.releaseGlobalLock=r}))):(t(!1),Promise.resolve())))})))}))}releaseCallLock(e){this.localLockedDevices.delete(e),this.releaseGlobalLock&&this.localLockedDevices.size===0&&this.releaseGlobalLock()}checkWebLocksSupport(){return l(this,void 0,void 0,(function*(){return!!(yield this.navigatorLocks.query().catch((()=>{P("WebLocks unsupported. The cross-tab call lock is disabled.",this.logger,T.WARNING)})))}))}}class ne{constructor(e,t,s,r){this.scanner=e,this.deviceEventHandler=t,this.sdkInputEventHandler=s,this.logger=r,this.readyEvent=new g,this.events=new $,this.events=A(this.readyEvent,this.deviceEventHandler.events,this.sdkInputEventHandler.events)}start(){this.readyEvent.next({event:"ready",version:null,jabraDirectInstalled:!1}),this.readyEvent.complete(),this.scanner.getPairedDevices(),this.scanner.setupListeners()}sendMessage(e){var t,s;return(s=(t=this.sdkInputEventHandler)===null||t===void 0?void 0:t.onNewSdkInput(e))!==null&&s!==void 0?s:Promise.resolve()}}function de(u){if(typeof window>"u")throw new h("WebHID is not supported outside of a browser environment.",p.INIT_ERROR);if(window.navigator===void 0||window.navigator.hid===void 0)throw new h("WebHID is not supported on this platform/browser.",p.INIT_ERROR);if(window.navigator.locks===void 0)throw new h("WebLocks is not supported on this platform/browser.",p.INIT_ERROR);const e=window.navigator.hid,t=window.navigator.locks,s=new BroadcastChannel(M.PAIRING_CHANNEL),r=new E(e,s),o=new Z(r),i=new m(o),n=new oe(o,new ie(t,o,u));return new ne(r,i,n,u)}export{de as initHandler};
